<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Legend AI • TradingView Symbol Lab</title>
    <link rel="stylesheet" href="/static/css/dashboard.css?v={{ build_sha }}" />
    <style>
        body.tv-symbol-lab {
            background: #05080f;
            color: var(--color-text-primary, #e5e7eb);
            font-family: var(--font-sans, 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif);
            min-height: 100vh;
            padding: var(--spacing-2xl, 32px);
        }
        .tv-lab-header {
            display: flex;
            flex-wrap: wrap;
            align-items: baseline;
            justify-content: space-between;
            gap: var(--spacing-lg);
            margin-bottom: var(--spacing-2xl, 32px);
        }
        .tv-lab-header h1 {
            margin: 0;
            font-size: clamp(1.5rem, 2vw, 2.25rem);
            background: linear-gradient(135deg, #60a5fa, #d946ef);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        .tv-lab-symbol {
            font-size: var(--font-size-lg, 1.25rem);
            font-weight: var(--font-weight-semibold, 600);
            letter-spacing: 0.1em;
        }
        .tv-lab-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
            gap: var(--spacing-xl, 24px);
            margin-top: var(--spacing-xl, 24px);
        }
        .tv-lab-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(460px, 1fr));
            gap: var(--spacing-xl, 24px);
            margin-top: var(--spacing-xl, 24px);
        }
        .tv-lab-card {
            background: rgba(15, 23, 42, 0.8);
            border-radius: var(--radius-2xl, 20px);
            border: 1px solid rgba(255, 255, 255, 0.08);
            padding: var(--spacing-lg, 24px);
            min-height: 320px;
        }
        .tv-lab-card h2 {
            margin-top: 0;
            margin-bottom: var(--spacing-md, 16px);
            font-size: 1rem;
            letter-spacing: 0.08em;
            text-transform: uppercase;
            color: var(--color-text-secondary, #9ca3af);
        }
        .tradingview-widget-container {
            width: 100%;
            height: 100%;
        }
        .tv-snapshot {
            display: flex;
            flex-direction: column;
            gap: var(--spacing-md, 16px);
            align-items: center;
            justify-content: center;
        }
        .tv-snapshot img {
            width: 100%;
            max-width: 100%;
            border-radius: var(--radius-xl, 16px);
            border: 1px solid rgba(255, 255, 255, 0.08);
        }
        .tv-snapshot-empty {
            text-align: center;
            color: var(--color-text-secondary, #9ca3af);
        }
        @media (max-width: 640px) {
            body.tv-symbol-lab {
                padding: var(--spacing-lg, 24px);
            }
        }
    </style>
</head>
<body class="tv-symbol-lab">
    <header class="tv-lab-header">
        <div>
            <p class="eyebrow">Legend AI</p>
            <h1>TradingView Symbol Lab</h1>
            <p class="tv-lab-symbol" data-testid="tv-lab-symbol-label">__TV_SYMBOL__</p>
        </div>
        <div>
            <a href="/dashboard" class="btn btn-secondary" data-testid="tv-lab-back-link">← Back to dashboard</a>
        </div>
    </header>

    <section class="tv-lab-card" style="min-height:120px;">
        <h2>Ticker tape</h2>
        <div class="tradingview-widget-container" data-testid="tv-lab-ticker-tape">
          <div class="tradingview-widget-container__widget"></div>
          <script type="text/javascript" src="https://s3.tradingview.com/external-embedding/embed-widget-ticker-tape.js" async>
          {
            "symbols": [
              { "proName": "FOREXCOM:SPXUSD", "title": "S&P 500" },
              { "proName": "NASDAQ:NDX", "title": "Nasdaq 100" },
              { "proName": "DJI", "title": "Dow 30" },
              { "proName": "NASDAQ:QQQ", "title": "QQQ" },
              { "title": "__TV_SYMBOL__", "proName": "__TV_SYMBOL__" }
            ],
            "colorTheme": "dark",
            "isTransparent": false,
            "displayMode": "adaptive",
            "width": "100%",
            "height": 96,
            "locale": "en"
          }
          </script>
        </div>
    </section>

    <section class="tv-lab-grid">
        <div class="tv-lab-card">
            <h2>Symbol info</h2>
            <div class="tradingview-widget-container" data-testid="tv-lab-symbol-info">
              <div class="tradingview-widget-container__widget"></div>
              <script type="text/javascript" src="https://s3.tradingview.com/external-embedding/embed-widget-symbol-info.js" async>
              {
                "symbol": "__TV_SYMBOL__",
                "width": "100%",
                "locale": "en",
                "colorTheme": "dark",
                "isTransparent": false
              }
              </script>
            </div>
        </div>
        <div class="tv-lab-card">
            <h2>Company profile</h2>
            <div class="tradingview-widget-container" data-testid="tv-lab-profile">
              <div class="tradingview-widget-container__widget"></div>
              <script type="text/javascript" src="https://s3.tradingview.com/external-embedding/embed-widget-symbol-profile.js" async>
              {
                "symbol": "__TV_SYMBOL__",
                "height": "100%",
                "colorTheme": "dark",
                "isTransparent": false,
                "locale": "en"
              }
              </script>
            </div>
        </div>
    </section>

    <section class="tv-lab-row">
        <div class="tv-lab-card" style="grid-column: span 2;">
            <h2>Advanced chart</h2>
            <div class="tradingview-widget-container" data-testid="tv-lab-advanced-chart">
              <div class="tradingview-widget-container__widget"></div>
              <script type="text/javascript" src="https://s3.tradingview.com/external-embedding/embed-widget-advanced-chart.js" async>
              {
                "symbol": "__TV_SYMBOL__",
                "interval": "D",
                "timezone": "America/New_York",
                "theme": "dark",
                "style": "1",
                "locale": "en",
                "allow_symbol_change": true,
                "calendar": true,
                "studies": [
                  "MAExp@tv-basicstudies",
                  "MASimple@tv-basicstudies",
                  "RelativeStrengthIndex@tv-basicstudies"
                ],
                "support_host": "https://www.tradingview.com",
                "hide_side_toolbar": false,
                "height": 620,
                "width": "100%"
              }
              </script>
            </div>
        </div>
    </section>

    <section class="tv-lab-grid">
        <div class="tv-lab-card">
            <h2>Fundamentals</h2>
            <div class="tradingview-widget-container" data-testid="tv-lab-fundamentals">
              <div class="tradingview-widget-container__widget"></div>
              <script type="text/javascript" src="https://s3.tradingview.com/external-embedding/embed-widget-symbol-profile.js" async>
              {
                "symbol": "__TV_SYMBOL__",
                "height": "100%",
                "colorTheme": "dark",
                "isTransparent": false,
                "locale": "en",
                "mode": "financials"
              }
              </script>
            </div>
        </div>
        <div class="tv-lab-card">
            <h2>Technical analysis</h2>
            <div class="tradingview-widget-container" data-testid="tv-lab-technical">
              <div class="tradingview-widget-container__widget"></div>
              <script type="text/javascript" src="https://s3.tradingview.com/external-embedding/embed-widget-technical-analysis.js" async>
              {
                "interval": "1D",
                "symbol": "__TV_SYMBOL__",
                "showIntervalTabs": true,
                "width": "100%",
                "height": "100%",
                "isTransparent": false,
                "colorTheme": "dark",
                "locale": "en"
              }
              </script>
            </div>
        </div>
    </section>

    <section class="tv-lab-grid">
        <div class="tv-lab-card">
            <h2>Top stories</h2>
            <div class="tradingview-widget-container" data-testid="tv-lab-news">
              <div class="tradingview-widget-container__widget"></div>
              <script type="text/javascript" src="https://s3.tradingview.com/external-embedding/embed-widget-timeline.js" async>
              {
                "feedMode": "symbol",
                "symbol": "__TV_SYMBOL__",
                "colorTheme": "dark",
                "isTransparent": false,
                "displayMode": "adaptive",
                "width": "100%",
                "height": 480,
                "locale": "en"
              }
              </script>
            </div>
        </div>
        <div class="tv-lab-card tv-lab-card--snapshot">
            <h2>Legend AI Chart-IMG snapshot</h2>
            <div class="tv-snapshot" data-testid="tv-lab-snapshot">
                <img id="chartimg-snapshot" alt="Legend AI snapshot" style="display:none;" />
                <div id="chartimg-status" class="tv-snapshot-empty">Generating snapshot…</div>
            </div>
        </div>
    </section>

    <script>
      (function() {
        const tvSymbol = '__TV_SYMBOL__';
        const ticker = tvSymbol.includes(':') ? tvSymbol.split(':')[1] : tvSymbol;
        const statusEl = document.getElementById('chartimg-status');
        const imgEl = document.getElementById('chartimg-snapshot');

        fetch('/api/charts/generate', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ ticker, interval: '1D' })
        })
        .then((res) => res.json())
        .then((payload) => {
          if (payload?.success && payload.chart_url) {
            imgEl.src = payload.chart_url;
            imgEl.style.display = 'block';
            statusEl.textContent = 'Snapshot synced via Chart-IMG';
          } else {
            statusEl.textContent = 'Snapshot unavailable (Chart-IMG limit or symbol unsupported)';
          }
        })
        .catch(() => {
          statusEl.textContent = 'Snapshot unavailable (network error)';
        });
      })();
    </script>
</body>
</html>
