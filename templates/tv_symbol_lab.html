<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Legend AI • TradingView Symbol Lab</title>
    <link rel="stylesheet" href="/static/css/cyberpunk-design-system.css?v={{ build_sha }}" />
    <link rel="stylesheet" href="/static/css/dashboard.css?v={{ build_sha }}" />
</head>
<body class="app-shell tv-symbol-lab" data-default-tv-symbol="__DEFAULT_TV_SYMBOL__">
    <main class="container tv-lab">
        <header class="tv-lab-header">
            <div>
                <p class="eyebrow">Legend AI</p>
                <h1>TradingView Symbol Lab</h1>
                <p class="tv-symbol-pill" data-testid="tv-lab-symbol-label" data-tv-symbol-label>NASDAQ:AAPL</p>
            </div>
            <div class="tv-header-actions">
                <a href="/dashboard" class="btn btn-secondary" data-testid="tv-lab-back-link">← Back to dashboard</a>
            </div>
        </header>

        <section class="tv-lab-stack">
            <div class="tv-grid tv-grid--stacked">
                <article class="tv-card" data-testid="tv-lab-ticker-tape">
                    <div class="tv-card-header">
                        <p class="eyebrow">Market tape</p>
                        <span class="tv-label-inline" data-tv-symbol-label>NASDAQ:AAPL</span>
                    </div>
                    <div data-tv-widget-target="tv-template-ticker-tape"></div>
                </article>
            </div>

            <div class="tv-grid tv-grid--charts">
                <article class="tv-card tv-card--chart" data-testid="tv-lab-advanced-chart">
                    <div class="tv-card-header">
                        <p class="eyebrow">Advanced chart</p>
                        <span class="tv-label-inline" data-tv-symbol-label>NASDAQ:AAPL</span>
                    </div>
                    <div data-tv-widget-target="tv-template-advanced-chart"></div>
                </article>
                <article class="tv-card tv-card--chart" data-testid="tv-lab-weekly-chart">
                    <div class="tv-card-header">
                        <p class="eyebrow">Weekly confirmation</p>
                        <span class="tv-label-inline" data-tv-symbol-label>NASDAQ:AAPL</span>
                    </div>
                    <div data-tv-widget-target="tv-template-advanced-chart-weekly"></div>
                </article>
            </div>

            <div class="tv-grid tv-grid--info">
                <article class="tv-card tv-card--info tv-card--tv-info" data-testid="tv-lab-symbol-info">
                    <div class="tv-card-header">
                        <p class="eyebrow">Symbol info</p>
                        <span class="tv-label-inline" data-tv-symbol-label>NASDAQ:AAPL</span>
                    </div>
                    <div data-tv-widget-target="tv-template-symbol-info"></div>
                </article>
                <article class="tv-card tv-card--info tv-card--tv-info" data-testid="tv-lab-technical">
                    <div class="tv-card-header">
                        <p class="eyebrow">Technical analysis</p>
                        <span class="tv-label-inline" data-tv-symbol-label>NASDAQ:AAPL</span>
                    </div>
                    <div data-tv-widget-target="tv-template-technical-analysis"></div>
                </article>
            </div>

            <div class="tv-grid tv-grid--profile">
                <article class="tv-card tv-card--profile tv-card--tv-fundamentals" data-testid="tv-lab-profile">
                    <div class="tv-card-header">
                        <p class="eyebrow">Company profile</p>
                        <span class="tv-label-inline" data-tv-symbol-label>NASDAQ:AAPL</span>
                    </div>
                    <div data-tv-widget-target="tv-template-company-profile"></div>
                </article>
                <article class="tv-card tv-card--fundamentals tv-card--tv-fundamentals" data-testid="tv-lab-fundamentals">
                    <div class="tv-card-header">
                        <p class="eyebrow">Fundamentals</p>
                        <span class="tv-label-inline" data-tv-symbol-label>NASDAQ:AAPL</span>
                    </div>
                    <div data-tv-widget-target="tv-template-fundamentals"></div>
                </article>
            </div>

            <article class="tv-card tv-card--news tv-lab-news tv-card--tv-news" data-testid="tv-lab-news">
                <div class="tv-card-header">
                    <p class="eyebrow">Top stories</p>
                    <span class="tv-label-inline" data-tv-symbol-label>NASDAQ:AAPL</span>
                </div>
                <div data-tv-widget-target="tv-template-news-timeline"></div>
            </article>

            <div class="tv-grid tv-grid--stacked tv-grid--snapshot">
                <article class="tv-card tv-card--snapshot" data-testid="tv-lab-snapshot">
                    <div class="tv-card-header">
                        <p class="eyebrow">Legend AI snapshot</p>
                        <span class="tv-label-inline" data-tv-symbol-label>NASDAQ:AAPL</span>
                    </div>
                    <div class="tv-snapshot">
                        <img id="chartimg-snapshot" alt="Legend AI snapshot" style="display:none;" />
                        <div id="chartimg-status" class="tv-snapshot-empty">Generating snapshot…</div>
                    </div>
                </article>
            </div>
        </section>
    </main>

    <!-- Shared TradingView templates -->
    <!--TV_WIDGET_TEMPLATES-->

    <script defer src="/static/js/tv-widgets.js?v={{ build_sha }}"></script>
    <script>
      (function() {
        function normalizeTicker(symbol) {
          if (!symbol) return null;
          const parts = symbol.split(':');
          return parts[parts.length - 1];
        }
        function renderSnapshot(symbol) {
          const ticker = normalizeTicker(symbol);
          const statusEl = document.getElementById('chartimg-status');
          const imgEl = document.getElementById('chartimg-snapshot');
          if (!ticker || !statusEl || !imgEl) return;
          statusEl.textContent = 'Generating snapshot…';
          imgEl.style.display = 'none';
          fetch('/api/charts/generate', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ ticker, interval: '1D' })
          })
          .then((res) => res.json())
          .then((payload) => {
            if (payload?.success && payload.chart_url) {
              imgEl.src = payload.chart_url;
              imgEl.style.display = 'block';
              statusEl.textContent = `Snapshot synced for ${ticker}`;
            } else {
              statusEl.textContent = 'Snapshot unavailable (limit or unsupported symbol)';
            }
          })
          .catch(() => {
            statusEl.textContent = 'Snapshot unavailable (network error)';
          });
        }
        document.addEventListener('legend-tv:ready', (event) => renderSnapshot(event.detail?.symbol));
        document.addEventListener('legend-tv:symbol-changed', (event) => renderSnapshot(event.detail?.symbol));
      })();
    </script>
</body>
</html>
